{% extends 'base.html' %}
{% block title %}AI 語音轉錄與摘要{% endblock %}
{% block content %}
  <h1 class="mb-4">AI 語音轉錄與摘要系統</h1>

  <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" aria-live="polite" aria-atomic="true">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        {% for msg in messages %}
          <div class="toast align-items-center text-bg-info border-0" role="status" data-bs-delay="4000">
            <div class="d-flex">
              <div class="toast-body">{{ msg }}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="關閉"></button>
            </div>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}
  </div>

  {% if not current_user.is_authenticated %}
    <div class="alert alert-warning">
      請先 <a href="{{ url_for('login') }}">登入</a> 或 <a href="{{ url_for('register') }}">註冊</a> 才能上傳並處理音檔。
      {% if google_enabled %}
        <div class="mt-2">
          <a class="btn btn-outline-danger" href="{{ url_for('auth_google') }}">使用 Google 帳號快速登入</a>
        </div>
      {% endif %}
    </div>
  {% endif %}

  {% if (step|default(1)) == 1 and current_user.is_authenticated %}
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">步驟一：上傳音檔並自動切割</h5>
        <form id="uploadForm" action="{{ url_for('upload') }}" method="post" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="file" class="form-label">支援 mp3 / wav / m4a</label>
            <div id="dropZone" class="drop-zone mb-2" tabindex="0" aria-label="拖放音檔或點擊選擇">
              將音檔拖放到這裡，或點擊選擇檔案
            </div>
            <input class="form-control" type="file" name="file" id="file" accept=".mp3,.wav,.m4a,audio/*" required hidden>
            <div id="fileInfo" class="form-text text-muted"></div>
            <div class="form-text">單檔上限 200MB，可視需求在設定檔調整。</div>
          </div>
          <button id="uploadBtn" class="btn btn-primary" type="submit">
            <span class="spinner-border spinner-border-sm me-2 d-none" aria-hidden="true" id="uploadSpinner"></span>
            上傳並切割
          </button>
          <a class="btn btn-outline-secondary ms-2" href="{{ url_for('try_demo') }}">使用範例音檔</a>
        </form>
      </div>
    </div>
  {% endif %}

  {% if step == 2 and current_user.is_authenticated %}
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-2">步驟二：決定要處理的段數</h5>
        <div class="alert alert-success mb-3">音檔已切割為 <strong>{{ total_segments }}</strong> 段。</div>
        <form id="runForm" action="{{ url_for('run') }}" method="post">
          <div class="mb-3">
            <label for="max_segments" class="form-label">要處理的段數（留空表示全部）</label>
            <input type="number" name="max_segments" id="max_segments" class="form-control" placeholder="例如 3" min="1" max="{{ total_segments }}" value="3">
            <div class="form-text">建議先處理少量段數確認結果，再執行全部。</div>
          </div>
          <button id="runBtn" class="btn btn-primary" type="submit">
            <span class="spinner-border spinner-border-sm me-2 d-none" aria-hidden="true" id="runSpinner"></span>
            開始處理
          </button>
          <a class="btn btn-outline-secondary ms-2" href="{{ url_for('index') }}">重新上傳</a>
        </form>
      </div>
    </div>
  {% endif %}

  {% if report_link and current_user.is_authenticated %}
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">處理完成</h5>
        <div class="d-flex flex-wrap gap-2">
          <a class="btn btn-success" href="{{ url_for('download', filename=report_link) }}">
            下載 DOCX：{{ (report_link.rsplit('/',1)[-1]) if report_link else '' }}
          </a>
          <a class="btn btn-outline-success" href="{{ url_for('download_zip', report=report_link) }}">
            下載全部結果（ZIP）
          </a>
        </div>
      </div>
    </div>
  {% endif %}

  {% if transcript_text and current_user.is_authenticated %}
    <div class="section-title">合併逐字稿（transcript.txt）</div>
    <pre class="content-pre">{{ transcript_text }}</pre>
  {% endif %}

  {% if review_text and current_user.is_authenticated %}
    <div class="section-title">審閱重點（transcript_review.txt）</div>
    <pre class="content-pre">{{ review_text }}</pre>
  {% endif %}

  {% if revised_text and current_user.is_authenticated %}
    <div class="section-title">修訂後逐字稿（transcript_revised.txt）</div>
    <pre class="content-pre">{{ revised_text }}</pre>
  {% endif %}

  {% if current_user.is_authenticated and monthly_usage_seconds is not none %}
    <div class="alert alert-secondary" role="alert">
      Plan: {{ current_user.plan or 'free' }}
      &nbsp;|&nbsp;
      Usage this month: {{ (monthly_usage_seconds // 60)|int }}
      {% if monthly_quota_seconds is not none %}/ {{ (monthly_quota_seconds // 60)|int }}{% else %}/ ∞{% endif %} min
      <a class="ms-2" href="{{ url_for('billing') }}">Billing</a>
    </div>
  {% endif %}

{% endblock %}
{% block scripts %}
<script>
  document.querySelectorAll('.toast').forEach(t => new bootstrap.Toast(t).show());

  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('file');
  const fileInfo = document.getElementById('fileInfo');
  if (dropZone && fileInput) {
    const openPicker = () => fileInput.click();
    dropZone.addEventListener('click', openPicker);
    dropZone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        openPicker();
      }
    });
    ['dragenter', 'dragover'].forEach(evt => dropZone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.add('drag-over');
    }));
    ['dragleave', 'drop'].forEach(evt => dropZone.addEventListener(evt, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropZone.classList.remove('drag-over');
    }));
    dropZone.addEventListener('drop', (e) => {
      if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        fileInfo.textContent = `已選擇：${fileInput.files[0].name}`;
      }
    });
    fileInput.addEventListener('change', () => {
      if (fileInput.files && fileInput.files.length) {
        fileInfo.textContent = `已選擇：${fileInput.files[0].name}`;
      } else {
        fileInfo.textContent = '';
      }
    });
  }

  const bindLoading = (formId, btnId, spinnerId, btnTextProcessing) => {
    const form = document.getElementById(formId);
    const btn = document.getElementById(btnId);
    const spinner = document.getElementById(spinnerId);
    if (!form || !btn || !spinner) return;
    form.addEventListener('submit', () => {
      btn.disabled = true;
      spinner.classList.remove('d-none');
      btn.dataset.originalText = btn.textContent;
      btn.textContent = btnTextProcessing;
    });
  };
  bindLoading('uploadForm', 'uploadBtn', 'uploadSpinner', '處理中...');
  bindLoading('runForm', 'runBtn', 'runSpinner', '處理中...');
</script>
{% endblock %}
